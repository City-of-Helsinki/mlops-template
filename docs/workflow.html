---

title: Workflow


keywords: fastai
sidebar: home_sidebar

summary: "Define static or dynamic workflow for automatically updating, training and deploying your ML model!"
description: "Define static or dynamic workflow for automatically updating, training and deploying your ML model!"
nb_path: "03_workflow.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 03_workflow.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong><em>input:</em></strong> Workflow definition parameters</p>
<p><strong><em>output:</em></strong> python or snakemake script for running the workflow</p>
<p><strong><em>description:</em></strong></p>
<p>While you are developing your ML application, you might prefer running the notebooks manually again and again.
However, once you have deployed your model into production it becomes unpractical and compromizes scalability, modularity and the principle of ease of reproducibility.
This happens regardless of what 'production' means to you - it might well be that you are just running the notebooks and viewing the results directly from them.
Whatever you are doing, having a single command to run the whole workflow makes things so much easier.</p>
<p>Workflow automation is also the part of the work where you'll probably notice a lot of bugs and nonrobustness in your notebooks.
Probably a lot more than you anticipated, but try not to get frustrated! Debugging is big and important part of the work.</p>
<p>In this notebook we explain alternatives for automating workflows, either as a static or dynamic. 
By following these examples (and further documentation on <a href="https://papermill.readthedocs.io/">papermill</a> and <a href="https://snakemake.readthedocs.io/">Snakemake</a>) you can parameterize your notebooks,
run them automatically in a workflow, and even parameterize and automate the workflow definition.
With this template, you can easily define very complex and versatile workflows, that are well documented in a notebook.</p>
<p>We selected these tools for the template because they have stable community support, they are relatively easy to use and they fit our needs.
There are also other tools for workflow management and orchestration that may better suite your needs. Feel free to use them.
For more information, see for example this 
<a href="https://medium.com/@Minyus86/comparison-of-pipeline-workflow-packages-airflow-luigi-gokart-metaflow-kedro-pipelinex-5daf57c17e7">comparison of workflow tools for Python</a>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Import-relevant-modules">Import relevant modules<a class="anchor-link" href="#Import-relevant-modules"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">papermill</span> <span class="k">as</span> <span class="nn">pm</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Define-notebook-parameters">Define notebook parameters<a class="anchor-link" href="#Define-notebook-parameters"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>make direct derivations from the paramerters:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="How-to-run-parameterized-notebooks-with-papermill">How to run parameterized notebooks with papermill<a class="anchor-link" href="#How-to-run-parameterized-notebooks-with-papermill"> </a></h2><p>Papermill allows parameterizing and running notebooks from Python runtime with <code>papermill.execute_notebook(input, output, parameters)</code>.
The <code>input</code> parameter is the notebook to be run. The <code>output</code> parameter is the filepath where copy of the executed notebook is saved with the results.
This can be the same as the <code>input</code>, but you probably want to keep it separate - otherwise your version control may get messy. 
In this example executed notebooks are saved under <code>results/notebooks</code>. The <code>parameters</code> cell allows you to change settings of the notebooks.</p>
<p>You may have noticed, that in the beginning of each notebook there is a cell with a comment <code># This cell is tagged parameters</code>.
The cell has been added <code>Parameters</code> tag. The template notebooks already contain the tag, 
but you can check <a href="https://papermill.readthedocs.io/en/latest/usage-parameterize.html">papermill documentation</a> on how to do it on different notebook editors.
In this cell, variables are assigned. What papermill does is, that any parameters given to the <code>execute_notebook</code> function are listed 
in a new cell right below the one tagged with parameters. The listed parameters will rewrite the default assignments.
This is why you should not do anything else but simple assignments in the parameters cell.</p>
<p>Let's show an example. Let's run the notebook 'model' with and without changing the 'seed'-parameter.
Copies of the notebooks executed with different settings are stored in <code>results/notebooks</code>.
The copies are saved with underscore prefix <code>_notebook.ipynb</code> so that they are ignored by nbdev.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># run model notebook with default parameters</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">execute_notebook</span><span class="p">(</span>
    <span class="s2">&quot;02_loss.ipynb&quot;</span><span class="p">,</span>
    <span class="s2">&quot;results/notebooks/_02_loss_default_params.ipynb&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># run model notebook with &#39;seed&#39; -parameter changed from 0 to 1</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">execute_notebook</span><span class="p">(</span>
    <span class="s2">&quot;02_loss.ipynb&quot;</span><span class="p">,</span> <span class="s2">&quot;results/notebooks/_02_loss_seed_1.ipynb&quot;</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;seed&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>You can now open the notebooks and compare the results.</p>
<p>Now we could just define and run the complete workflow from this notebook: just define which notebooks to run, in which order and with which parameters.
Then just run this notebook and the workflow is executed.
We could even go further and parameterize this notebook to get parameterizable workflow execution.
Then, we could use papermill in another application to run this notebook to execute the rest of the workflow.
However, this approach has two main restrictions. The workflow execution script would not be included in this documentation, and it does not allow dynamic workflows because launching Snakemake from inside a Python runtime will cause all sorts of problems.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Static-executable-workflow-with-papermill">Static executable workflow with papermill<a class="anchor-link" href="#Static-executable-workflow-with-papermill"> </a></h2><p>If we want to automatically run the workflow, we need to create and executable script to run it.
We can define it in this notebook to include it in our documentation:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">dict</span><span class="p">(</span><span class="n">seed</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;seed&#39;: 3}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%writefile</span> static_workflow.py
<span class="c1"># execute workflow of the example notebooks</span>
<span class="c1"># to run the script, call python static_workflow.py workflow_setup.yaml</span>
<span class="c1"># this file has been added to .gitignore</span>
<span class="c1"># NOTE: use curly brackets only to format in global variables!</span>
<span class="c1"># hint: you can include additional parameters with sys.argv</span>

<span class="c1"># import relevant libraries</span>
<span class="kn">import</span> <span class="nn">papermill</span> <span class="k">as</span> <span class="nn">pm</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">yaml</span>

<span class="c1"># update modules before running just to be sure</span>
<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;nbdev_build_lib&#39;</span><span class="p">)</span>

<span class="c1"># run data notebook</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">execute_notebook</span><span class="p">(</span><span class="s1">&#39;00_data.ipynb&#39;</span><span class="p">,</span> <span class="c1"># input</span>
                        <span class="s1">&#39;results/notebooks/_00_data.ipynb&#39;</span><span class="p">,</span> <span class="c1"># output</span>
                       <span class="n">parameters</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">seed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># params (optional)</span>
                       <span class="p">)</span>
<span class="c1"># run model notebook</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">execute_notebook</span><span class="p">(</span><span class="s1">&#39;01_model.ipynb&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;results/notebooks/_01_model.ipynb&#39;</span><span class="p">)</span>
<span class="c1"># run loss notebook</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">execute_notebook</span><span class="p">(</span><span class="s1">&#39;02_loss.ipynb&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;results/_02_loss.ipynb&#39;</span><span class="p">)</span>

<span class="c1"># optional (uncomment): make backup of the index and workflow notebooks:</span>
<span class="c1"># os.system(&#39;cp {workflow} {save_notebooks_to}{workflow}&#39;)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Overwriting static_workflow.py
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Parameterized-static-executable-workflow-with-papermill">Parameterized static executable workflow with papermill<a class="anchor-link" href="#Parameterized-static-executable-workflow-with-papermill"> </a></h2><p>What if some of your input files change, or you would like to run your workflow with a slighly different setup?
Alternative approach is then to use this notebook to define a execution script and a configuration file.
This has the advantages of including everything in your project documentation, and allowing very complex workflows.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%writefile</span> workflow_setup.yml
<span class="o">---</span>
<span class="n">notebooks</span><span class="p">:</span> <span class="c1"># workflow notebook setup</span>
    <span class="n">index</span><span class="p">:</span> <span class="c1"># name of notebook</span>
        <span class="n">notebook</span><span class="p">:</span> <span class="n">index</span><span class="o">.</span><span class="n">ipynb</span> <span class="c1"># notebook file</span>

    <span class="n">data</span><span class="p">:</span>
        <span class="n">notebook</span><span class="p">:</span> <span class="mi">00</span><span class="n">_data</span><span class="o">.</span><span class="n">ipynb</span>
        <span class="n">params</span><span class="p">:</span> <span class="c1"># notebook parameters</span>
            <span class="n">seed</span><span class="p">:</span> <span class="mi">0</span>
    <span class="n">model</span><span class="p">:</span>
        <span class="n">notebook</span><span class="p">:</span> <span class="mi">01</span><span class="n">_model</span><span class="o">.</span><span class="n">ipynb</span>
        <span class="n">params</span><span class="p">:</span>
            <span class="n">seed</span><span class="p">:</span> <span class="mi">0</span>
    <span class="n">loss</span><span class="p">:</span>
        <span class="n">notebook</span><span class="p">:</span> <span class="mi">02</span><span class="n">_loss</span><span class="o">.</span><span class="n">ipynb</span>
        <span class="n">params</span><span class="p">:</span>
            <span class="n">seed</span><span class="p">:</span> <span class="mi">0</span>
<span class="n">utils</span><span class="p">:</span> <span class="c1"># general workflow settings</span>
    <span class="n">save_notebooks_to</span><span class="p">:</span> <span class="n">results</span><span class="o">/</span><span class="n">notebooks</span><span class="o">/</span>
    <span class="n">notebook_save_prefix</span><span class="p">:</span> <span class="n">_</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Overwriting workflow_setup.yml
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's take a look how the setup looks loaded as a python dictionary:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">yaml</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;workflow_setup.yml&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">setup_dict</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">Loader</span><span class="p">)</span>
<span class="n">setup_dict</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;notebooks&#39;: {&#39;index&#39;: {&#39;notebook&#39;: &#39;index.ipynb&#39;},
  &#39;data&#39;: {&#39;notebook&#39;: &#39;00_data.ipynb&#39;, &#39;params&#39;: {&#39;seed&#39;: 0}},
  &#39;model&#39;: {&#39;notebook&#39;: &#39;01_model.ipynb&#39;, &#39;params&#39;: {&#39;seed&#39;: 0}},
  &#39;loss&#39;: {&#39;notebook&#39;: &#39;02_loss.ipynb&#39;, &#39;params&#39;: {&#39;seed&#39;: 0}}},
 &#39;utils&#39;: {&#39;save_notebooks_to&#39;: &#39;results/notebooks/&#39;,
  &#39;notebook_save_prefix&#39;: &#39;_&#39;}}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Parameterized-static-executable-workflow-with-papermill">Parameterized static executable workflow with papermill<a class="anchor-link" href="#Parameterized-static-executable-workflow-with-papermill"> </a></h2><p>You can either read parameters directly form sys.argv, python argparser or, as we recommend, from a configuration file.</p>
<p>Now we can define a simple static parameterizable workflow. The workflow is a Python script, completely defined in this notebook for consistent of documentation (everything is defined in notebooks). We then export the script into a file, so that it can be executed outside this notebook. We added the script file to gitignore, because it is defined in this notebook and will be recreated every time this notebook is run. We define the script parameterization so, that the parameters are hard coded into the script file when it is generated, based on this notebook. So, to change the setup, you should run this notebook with different parameters. You may make different choises, but consider ease of reproducibility and be sure to document your work well.</p>
<p>Now run the cell below to create the execution script (the code is not run in this notebook):</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%writefile</span> static_workflow.py
<span class="c1"># execute workflow of the example notebooks</span>
<span class="c1"># to run the script, call python static_workflow.py workflow_setup.yaml</span>
<span class="c1"># this file has been added to .gitignore</span>
<span class="c1"># NOTE: use curly brackets only to format in global variables!</span>
<span class="c1"># hint: you can include additional parameters with sys.argv</span>

<span class="c1"># import relevant libraries</span>
<span class="kn">import</span> <span class="nn">papermill</span> <span class="k">as</span> <span class="nn">pm</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">yaml</span>

<span class="c1">## parse arguments from workflow_setup.yaml</span>
<span class="n">configfilename</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">configfilename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">Loader</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">Loader</span><span class="p">)</span>

<span class="c1"># variables</span>
<span class="n">notebooks</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;notebooks&#39;</span><span class="p">]</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">notebooks</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">notebooks</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
<span class="n">loss</span> <span class="o">=</span> <span class="n">notebooks</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span>

<span class="n">utils</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;utils&#39;</span><span class="p">]</span>

<span class="c1"># update modules before running just to be sure</span>
<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;nbdev_build_lib&#39;</span><span class="p">)</span>

<span class="c1"># run data notebook</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">execute_notebook</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;notebook&#39;</span><span class="p">],</span> <span class="c1"># input</span>
                        <span class="n">utils</span><span class="p">[</span><span class="s1">&#39;save_notebooks_to&#39;</span><span class="p">]</span> \
                        <span class="o">+</span> <span class="n">utils</span><span class="p">[</span><span class="s1">&#39;notebook_save_prefix&#39;</span><span class="p">]</span> \
                        <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;notebook&#39;</span><span class="p">],</span> <span class="c1"># output</span>
                       <span class="n">parameters</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span> <span class="c1"># params</span>
                       <span class="p">)</span>
<span class="c1"># run model notebook</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">execute_notebook</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="s1">&#39;notebook&#39;</span><span class="p">],</span>
                        <span class="n">utils</span><span class="p">[</span><span class="s1">&#39;save_notebooks_to&#39;</span><span class="p">]</span> \
                        <span class="o">+</span> <span class="n">utils</span><span class="p">[</span><span class="s1">&#39;notebook_save_prefix&#39;</span><span class="p">]</span> \
                        <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="s1">&#39;notebook&#39;</span><span class="p">],</span>
                       <span class="n">parameters</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">])</span>
<span class="c1"># run loss notebook</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">execute_notebook</span><span class="p">(</span><span class="n">loss</span><span class="p">[</span><span class="s1">&#39;notebook&#39;</span><span class="p">],</span>
                        <span class="n">utils</span><span class="p">[</span><span class="s1">&#39;save_notebooks_to&#39;</span><span class="p">]</span> \
                        <span class="o">+</span> <span class="n">utils</span><span class="p">[</span><span class="s1">&#39;notebook_save_prefix&#39;</span><span class="p">]</span> \
                        <span class="o">+</span> <span class="n">loss</span><span class="p">[</span><span class="s1">&#39;notebook&#39;</span><span class="p">],</span>
                       <span class="n">parameters</span> <span class="o">=</span> <span class="n">loss</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">])</span>

<span class="c1"># optional (uncomment): make backup of the index and workflow notebooks:</span>
<span class="c1"># os.system(&#39;cp {workflow} {save_notebooks_to}{workflow}&#39;)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Overwriting static_workflow.py
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If you open the file <code>static_workflow.py</code>, you notice that the contents of curly brackets were replaced with the parameters of this notebook.</p>
<p>Now, you can run the workflow:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># run this in your terminal to also run the nbdev_build_lib</span>
<span class="o">!</span>python static_workflow.py workflow_setup.yml
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>sh: 1: nbdev_build_lib: not found
Executing:   0%|                                       | 0/58 [00:00&lt;?, ?cell/s][IPKernelApp] WARNING | Unknown error in handling startup files:
Executing: 100%|██████████████████████████████| 58/58 [00:19&lt;00:00,  3.77cell/s]
Executing:   0%|                                       | 0/45 [00:00&lt;?, ?cell/s][IPKernelApp] WARNING | Unknown error in handling startup files:
Executing: 100%|██████████████████████████████| 45/45 [00:18&lt;00:00,  1.91cell/s]
Executing:   0%|                                       | 0/44 [00:00&lt;?, ?cell/s][IPKernelApp] WARNING | Unknown error in handling startup files:
Executing: 100%|██████████████████████████████| 44/44 [00:13&lt;00:00,  4.33cell/s]
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>You can again make a visible copy of the hidden notebooks folder just like above (remember to delete it afterwards) and view the notebooks.
You can change some of the notebook parameters and rerun the workflow to see how it effects the results.</p>
<p>You see that static workflow definition is quite simple. In the script above, 
we did not define any inputs, outputs or the relation of the different steps.
It's good to keep things that way, unless there is a reason not to.
It might be that we have multiple, changing data sources, complex workflow structure,
need for parallelization or other issues making it either difficult to hard-code
the steps required in your workflow. Then, you might need a dynamic workflow.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Dynamic-executable-workflow-with-Snakemake">Dynamic executable workflow with Snakemake<a class="anchor-link" href="#Dynamic-executable-workflow-with-Snakemake"> </a></h2><p>Snakemake is a tool that will automatically determine which steps to run based on inputs and outputs.
It's like gnu make, but for Python: easy to read and write, but powerful.
Unfortunaltely it is impossible to cover all the properties of the tool but see their documentation and internet discussion for ideas.
Here we only cover a tiny portion of the possibilities of snakemake, but it can do very complex things.</p>
<p>Snakemake executes the workflow as a rule based directed acyclic graph (DAG).
Each workflow step is determined by a rule, which consists of inputs, outputs and execution of code.
The inputs and outputs are files (data, config, source code, notebooks, images, tables etc.).
The code executed can either be shell commands or Python, written directly into the Snakefile.</p>
<p>Let's consider a workflow where we have two parallel rules 1a and 1b, and one consequtive rule 2.
In addition we have rule all, that determines the whole workflow.
The rules 1a and 1b only depend on their input. The rule 2 depends on outputs of both rules 1a and 1b.
The rule 2 also has an additional input independent of other rules.
We can visualize the workflow as follows:</p>
<p><img src="/ml_project_template/./visuals/snakemake_illustration_simple_workflow.png" alt="Workflow visualization example"></p>
<p>Now, if we turned it into a Snakefile script, it would look something like this:</p>

<pre><code>rule all: # used to determine the whole workflow
    input:
        output_2

rule 1a: # parallel to rule 1b
    input:
        input_1a
    output:
        output_1a
    run: # run python commands
        # Python script to run rule 1a

 rule 1b: # parallel to rule 1a
    input:
        input_1b
    output:
        output_1b
    shell: # you also run shell commands
        # shell script to run rule 1b

 rule 2: # consequent to steps 1a and 1b
    input:
        output_1a, # depends on rule 1a
        output_1b, # depends on rule 1b
        input_2 # independent input
    output:
        output_2
    run:
        # Python script to run rule2

</code></pre>
<p>Snakemake can be either used to run a single rule, or the complete workflow based on rule all.
Based on the inputs and outputs, snakemake will determine which other rules will then need to be executed.</p>
<p>In our example, the notebooks consist the nodes of the DAG graph. Based on the changes in input and output files since the last execution, 
Snakemake determines which steps need to be run. If no changes are observed, snakemake does not do anything.</p>
<p>The following script will be written into a Snakefile, that you can run to execute the workflow.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%writefile</span> Snakefile
<span class="c1"># import relevant libraries</span>
<span class="kn">import</span> <span class="nn">papermill</span> <span class="k">as</span> <span class="nn">pm</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># determine global variables, wildcards etc.</span>

<span class="c1"># all: final output of the workflow</span>
<span class="n">rule</span> <span class="nb">all</span><span class="p">:</span>
    <span class="nb">input</span><span class="p">:</span>
        <span class="s1">&#39;results/LogisticRegressionClassifier.pkl&#39;</span> <span class="c1"># trained model</span>
        
<span class="c1"># data</span>
<span class="n">rule</span> <span class="n">data</span><span class="p">:</span>
    <span class="nb">input</span><span class="p">:</span>
        <span class="s1">&#39;00_data.ipynb&#39;</span> <span class="c1"># every notebook is it&#39;s own input</span>
        <span class="c1"># if we had input files they should be listed here, separated with comma ,</span>
    <span class="n">output</span><span class="p">:</span> <span class="c1"># Snakemake checks that after running these files are created / updated</span>
        <span class="s1">&#39;data/preprocessed_data/dataset_clean_switzerland_cleveland.csv&#39;</span><span class="p">,</span>  <span class="c1"># clean dataset</span>
        <span class="s1">&#39;data/preprocessed_data/dataset_toy_switzerland_cleveland.csv&#39;</span><span class="p">,</span> <span class="c1"># toy dataset</span>
        <span class="s1">&#39;ml_project_template/data.py&#39;</span><span class="p">,</span> <span class="c1"># plot functions</span>
        <span class="s1">&#39;results/notebooks/_00_data.ipynb&#39;</span> <span class="c1"># copy of the executed notebook</span>
    <span class="n">run</span><span class="p">:</span>
        <span class="c1"># run notebook with papermill</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">execute_notebook</span><span class="p">(</span><span class="s1">&#39;00_data.ipynb&#39;</span><span class="p">,</span> <span class="c1"># input</span>
                                <span class="s1">&#39;results/notebooks/_00_data.ipynb&#39;</span><span class="p">,</span> <span class="c1"># output</span>
                               <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;seed&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">})</span> <span class="c1"># params (optional)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;nbdev_build_lib --fname 00_data.ipynb&#39;</span><span class="p">)</span> <span class="c1"># build data.py</span>

<span class="n">rule</span> <span class="n">model</span><span class="p">:</span>
    <span class="nb">input</span><span class="p">:</span>
        <span class="s1">&#39;01_model.ipynb&#39;</span><span class="p">,</span>
        <span class="s1">&#39;data/preprocessed_data/dataset_toy_switzerland_cleveland.csv&#39;</span><span class="p">,</span>
    <span class="n">output</span><span class="p">:</span>
        <span class="s1">&#39;ml_project_template/model.py&#39;</span><span class="p">,</span> <span class="c1"># model class</span>
        <span class="s1">&#39;results/notebooks/_01_model.ipynb&#39;</span>
    <span class="n">run</span><span class="p">:</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">execute_notebook</span><span class="p">(</span><span class="s1">&#39;01_model.ipynb&#39;</span><span class="p">,</span> <span class="c1"># we could also use &#39;{input[0]}&#39;</span>
                                <span class="s1">&#39;results/notebooks/_01_model.ipynb&#39;</span><span class="p">)</span> <span class="c1"># we could also use &#39;{output[1]}&#39;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;nbdev_build_lib --fname 01_model.ipynb&#39;</span><span class="p">)</span>
        
<span class="n">rule</span> <span class="n">loss</span><span class="p">:</span>
    <span class="nb">input</span><span class="p">:</span>
        <span class="s1">&#39;02_loss.ipynb&#39;</span><span class="p">,</span>
        <span class="s1">&#39;data/preprocessed_data/dataset_clean_switzerland_cleveland.csv&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ml_project_template/data.py&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ml_project_template/model.py&#39;</span>
    <span class="n">output</span><span class="p">:</span>
        <span class="s1">&#39;results/LogisticRegressionClassifier.pkl&#39;</span><span class="p">,</span> <span class="c1"># trained model</span>
        <span class="s1">&#39;results/notebooks/_02_loss.ipynb&#39;</span>
    <span class="n">run</span><span class="p">:</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">execute_notebook</span><span class="p">(</span><span class="s1">&#39;02_loss.ipynb&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;results/notebooks/_02_loss.ipynb&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;nbdev_build_lib --fname 02_loss.ipynb&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Overwriting Snakefile
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>One thing to notice is that Snakemake should be used from terminal directly, not from a Python script or notebook.</p>
<p>To run Snakemake, call:</p>

<pre><code>snakemake -n # dry-run snakemake to check what would be done
snakemake --jobs 1 # run workflow

</code></pre>
<p>The --jobs parameter (you can also use -j) is the maximum number of CPU cores to use with the pipeline (local/cluster/cloud cores).
Usually 1 is enough with simple pipelines, since our primary workflow step is a notebook, and most Python operations are difficult to parallelize.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Parameterized-dynamic-executable-workflow-with-Snakemake">Parameterized dynamic executable workflow with Snakemake<a class="anchor-link" href="#Parameterized-dynamic-executable-workflow-with-Snakemake"> </a></h2><p>Again, we might want to parameterize the notebook for scalability.</p>
<p>For simple parameterization, use rule parameters:</p>

<pre><code>rule model:
    input:
    output:
    parameters: seed = 0
    run:
        _ = pm.execute_notebook(...,
                                ...,
                           parameters = {seed: parameters.seed})

</code></pre>
<p>For complex parameterization, including the parameterization of inputs and outputs,
consider using a config file. Snakemake can automatically load  json or yaml file to python dictionary:</p>

<pre><code>## in config.yml:
rules:
    data:
        ...
    model:
        input:
            - 01_model.ipynb
            - data/preprocessed_data/dataset_toy_switzerland_cleveland.csv
        parameters:
            seed: 0
        ...
    ...


## in Snakefile:

# automatically load json or yaml file to python dictionary 'config'
configfile: config.yml

rule model:
    input:
        config['rules']['model']['input']
    output:
        ...
    run:
        run:
        _ = pm.execute_notebook(...,
                                ...,
                           parameters = {seed: config['rules']['model']['parameters']['seed']})


</code></pre>
<p>For more information, see <a href="https://snakemake.readthedocs.io/">Snakemake documentation</a>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Alternative-approach:-Use-this-notebook-to-create-main.py">Alternative approach: Use this notebook to create main.py<a class="anchor-link" href="#Alternative-approach:-Use-this-notebook-to-create-main.py"> </a></h2><p>If you just want to create conventional Python application, you can use this notebook to create main.py so that you can just run your module as python application.
Then, you should change the name of this notebook and the default_exp location to main. This requires that you define and export all functions and classes to modules so that they can be used elsewhere. This is a bit messy, and deminishes many of the benefits of notebook development because instead of just running the notebooks you already created, you have to redefine all the steps required all over again. However, sometimes this might be what you want to do, so we wanted to mention it here.</p>
<p>Pseudo example of how to define main.py in a notebook:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%</span><span class="k">script</span> False
## remove this line and the line above if you want to run and export the code (note that it needs editing to work)
### export main
# remove the two extra # in the line above

import numpy as np
import sys
import data, model, loss

def get_input():
    &quot;&quot;&quot;
    get input from user
    &quot;&quot;&quot;
    pass

def main(filename):
    &quot;&quot;&quot;
    run main loop
    &quot;&quot;&quot;
    # load data
    X, y = data.load(filename)
    # initialize model, fit, optimize
    m = model.LogisticRegressionClassifier(X, y).fit().optimize()
    # main loop
    input_data = get_input()
    while(input_data):
        if input_data[0] == &#39;predict&#39;:
            # predict on input
            print(m.predict(input_data[1]))
        else:
            # do other things
            pass
        
if __name__ == &quot;__main__&quot;:
    &quot;&quot;&quot;
    run with: python ml_project_template filename
    &quot;&quot;&quot;
    np.random.seed(0)
    filename = sys.argv[1]
    main(filename)
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Couldn&#39;t find program: &#39;False&#39;
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%</span><span class="k">script</span> False
## remove this line and the line above if you want to run the code (note that it needs editing to work)
## test the main loop in this notebook and interact with the application
main()
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Couldn&#39;t find program: &#39;False&#39;
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

